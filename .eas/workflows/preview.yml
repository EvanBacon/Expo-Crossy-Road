name: PR Preview

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  publish:
    type: custom
    image: latest
    outputs:
      project_id: ${{ steps.project.outputs.id }}
      update_output: ${{ steps.update.outputs.update_output }}
    steps:
      - name: ğŸ—„ï¸ Setup project
        uses: eas/checkout

      - name: ğŸ“¦ Install dependencies
        uses: eas/install_node_modules

      - name: ğŸ‘· Preparing project
        run: set-output id "${ eas.env.EAS_BUILD_PROJECT_ID }"

      - name: ğŸš€ Publish update
        id: update
        run: |
          OUTPUT=$(npx eas-cli update --branch "pr-${{ github.event.pull_request.number }}" --message "${{ github.event.pull_request.number }}" --json --non-interactive)
          set-output update_output "$OUTPUT"

  comment:
    type: github-comment
    needs: [publish]
    params:
      payload: |
        ğŸ“± **Preview is ready!**

          [Open in Expo Go](https://302.expo.app/u?url=exp://u.expo.dev/63c6199d-ad0f-4796-871b-b8d65e05680a/group/${{ fromJSON(needs.publish.outputs.update_output)[0].group }})

          exp://u.expo.dev/63c6199d-ad0f-4796-871b-b8d65e05680a/group/${{ fromJSON(needs.publish.outputs.update_output)[0].group }}